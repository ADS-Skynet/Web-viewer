<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lane Detection Viewer (ZMQ)</title>
    <style>
        body {{
            margin: 0;
            padding: 20px;
            background: #1e1e1e;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }}
        h1 {{
            margin: 0 0 20px 0;
            font-size: 24px;
            font-weight: 300;
        }}
        .container {{
            max-width: 1200px;
            width: 100%;
        }}
        .video-container {{
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }}
        img {{
            width: 100%;
            height: auto;
            display: block;
        }}
        .controls {{
            margin-top: 20px;
            padding: 15px;
            background: #2d2d2d;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }}
        .btn {{
            padding: 10px 20px;
            background: #4a4a4a;
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }}
        .btn:hover {{
            background: #5a5a5a;
        }}
        .btn.primary {{
            background: #2196F3;
        }}
        .btn.primary:hover {{
            background: #1976D2;
        }}
        .btn.warning {{
            background: #FF9800;
        }}
        .btn.warning:hover {{
            background: #F57C00;
        }}
        .btn.success {{
            background: #4CAF50;
        }}
        .btn.success:hover {{
            background: #45a049;
        }}
        .mode-controls {{
            margin-top: 20px;
            padding: 15px;
            background: #2d2d2d;
            border-radius: 8px;
        }}
        .mode-controls h3 {{
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #2196F3;
        }}
        .mode-buttons {{
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }}
        .mode-btn {{
            padding: 10px 20px;
            background: #4a4a4a;
            border: 2px solid #4a4a4a;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }}
        .mode-btn:hover {{
            background: #5a5a5a;
            border-color: #5a5a5a;
        }}
        .mode-btn.active {{
            background: #4CAF50;
            border-color: #4CAF50;
        }}
        .toggle-controls {{
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #4a4a4a;
        }}
        .toggle-buttons {{
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }}
        .toggle-btn {{
            padding: 8px 16px;
            background: #4CAF50;
            border: 2px solid #4CAF50;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }}
        .toggle-btn:hover {{
            opacity: 0.8;
        }}
        .toggle-btn.off {{
            background: #666;
            border-color: #666;
        }}
        .info {{
            margin-top: 20px;
            padding: 15px;
            background: #2d2d2d;
            border-radius: 8px;
            font-size: 14px;
        }}
        .info-item {{
            margin: 5px 0;
        }}
        .badge {{
            display: inline-block;
            padding: 2px 8px;
            background: #4CAF50;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }}
        .notification {{
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }}
        .notification.show {{
            opacity: 1;
        }}
        .notification.error {{
            background: #f44336;
        }}
        .params-container {{
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }}
        .param-section {{
            padding: 15px;
            background: #2d2d2d;
            border-radius: 8px;
        }}
        .param-section h3 {{
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #2196F3;
        }}
        .param-control {{
            margin-bottom: 12px;
        }}
        .param-control label {{
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            color: #aaa;
        }}
        .param-control input[type="range"] {{
            width: 100%;
            margin-bottom: 5px;
        }}
        .param-value {{
            font-size: 12px;
            color: #4CAF50;
            font-family: monospace;
        }}
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó Lane Detection Viewer <span class="badge" id="modeBadge">{target}</span></h1>
        <div class="video-container">
            <img id="videoStream" src="" alt="Lane Detection Stream">
        </div>
        <div class="controls">
            <button class="btn primary" id="respawnBtn" onclick="sendAction('respawn')" style="display: {respawn_display};">üîÑ Respawn Vehicle</button>
            <button class="btn warning" id="pauseBtn" onclick="togglePause()">üõë Stop</button>
            <button class="btn" id="resetBtn" onclick="resetSystem()">üîÑ Reset System</button>
        </div>
        <div class="mode-controls">
            <h3>üé® Visualization Layers</h3>
            <div class="toggle-buttons">
                <button class="toggle-btn" id="rawImageToggle" onclick="toggleRawImage()">üì∑ Raw Image: ON</button>
                <button class="toggle-btn" id="lanesToggle" onclick="toggleLanes()">üõ£Ô∏è Lanes: ON</button>
                <button class="toggle-btn off" id="cannyToggle" onclick="toggleCanny()">‚ö™ Canny: OFF</button>
                <button class="toggle-btn off" id="houghToggle" onclick="toggleHough()">üî¥ Hough: OFF</button>
                <button class="toggle-btn" id="hudToggle" onclick="toggleHUD()">üìä HUD: ON</button>
            </div>
        </div>
        <div class="info">
            <div class="info-item">
                <strong>Target:</strong> {target} | <strong>Mode:</strong> WebSocket Real-Time Streaming
            </div>
            <div class="info-item">
                <strong>Connection:</strong> <span id="wsStatus" style="color: #FF9800;">Connecting...</span>
                | <strong>Vehicle State:</strong> <span id="stateStatus" style="color: #666;">No data</span>
            </div>
            <div class="info-item">
                <strong>Source URL:</strong> {vehicle_url}
            </div>
            <div class="info-item">
                <strong>FPS:</strong> <span id="fpsDisplay">--</span> | <strong>Latency:</strong> <span id="latencyDisplay">--</span>ms
            </div>
            <div class="info-item">
                <strong>Speed:</strong> <span id="speedDisplay">--</span> km/h |
                <strong>Throttle:</strong> <span id="throttleDisplay" style="color: #4CAF50;">--</span> |
                <strong>Brake:</strong> <span id="brakeDisplay" style="color: #f44336;">--</span>
            </div>
        </div>

        <div class="params-container">
            <div class="param-section">
                <h3>üîç Detection Parameters</h3>
                <div class="param-control">
                    <label>Canny Low Threshold</label>
                    <input type="range" id="canny_low" min="1" max="150" value="{canny_low}" step="1"
                           oninput="updateParam('detection', 'canny_low', this.value)">
                    <span class="param-value" id="canny_low_val">{canny_low}</span>
                </div>
                <div class="param-control">
                    <label>Canny High Threshold</label>
                    <input type="range" id="canny_high" min="50" max="255" value="{canny_high}" step="1"
                           oninput="updateParam('detection', 'canny_high', this.value)">
                    <span class="param-value" id="canny_high_val">{canny_high}</span>
                </div>
                <div class="param-control">
                    <label>Hough Threshold</label>
                    <input type="range" id="hough_threshold" min="1" max="150" value="{hough_threshold}" step="1"
                           oninput="updateParam('detection', 'hough_threshold', this.value)">
                    <span class="param-value" id="hough_threshold_val">{hough_threshold}</span>
                </div>
                <div class="param-control">
                    <label>Hough Min Line Length</label>
                    <input type="range" id="hough_min_line_len" min="10" max="150" value="{hough_min_line_len}" step="5"
                           oninput="updateParam('detection', 'hough_min_line_len', this.value)">
                    <span class="param-value" id="hough_min_line_len_val">{hough_min_line_len}</span>
                </div>
                <div class="param-control">
                    <label>Hough Max Line Gap</label>
                    <input type="range" id="hough_max_line_gap" min="10" max="300" value="{hough_max_line_gap}" step="10"
                           oninput="updateParam('detection', 'hough_max_line_gap', this.value)">
                    <span class="param-value" id="hough_max_line_gap_val">{hough_max_line_gap}</span>
                </div>
                <div class="param-control">
                    <label>Smoothing Factor</label>
                    <input type="range" id="smoothing_factor" min="0" max="1" value="{smoothing_factor}" step="0.05"
                           oninput="updateParam('detection', 'smoothing_factor', this.value)">
                    <span class="param-value" id="smoothing_factor_val">{smoothing_factor:.2f}</span>
                </div>
            </div>

            <div class="param-section">
                <h3>üéØ Decision (PID Control) Parameters</h3>
                <div class="param-control">
                    <label>Kp (Proportional Gain)</label>
                    <input type="range" id="kp" min="0" max="2" value="0.5" step="0.05"
                           oninput="updateParam('decision', 'kp', this.value)">
                    <span class="param-value" id="kp_val">0.50</span>
                </div>
                <div class="param-control">
                    <label>Ki (Integral Gain)</label>
                    <input type="range" id="ki" min="0" max="0.5" value="0.01" step="0.005"
                           oninput="updateParam('decision', 'ki', this.value)">
                    <span class="param-value" id="ki_val">0.01</span>
                </div>
                <div class="param-control">
                    <label>Kd (Derivative Gain)</label>
                    <input type="range" id="kd" min="0" max="1" value="0.1" step="0.05"
                           oninput="updateParam('decision', 'kd', this.value)">
                    <span class="param-value" id="kd_val">0.10</span>
                </div>
                <div class="param-control">
                    <label>Base Throttle</label>
                    <input type="range" id="throttle_base" min="0" max="0.5" value="{throttle_base}" step="0.01"
                           oninput="updateParam('decision', 'throttle_base', this.value)">
                    <span class="param-value" id="throttle_base_val">{throttle_base:.2f}</span>
                </div>
                <div class="param-control">
                    <label>Min Throttle</label>
                    <input type="range" id="throttle_min" min="0" max="0.2" value="0.05" step="0.01"
                           oninput="updateParam('decision', 'throttle_min', this.value)">
                    <span class="param-value" id="throttle_min_val">0.05</span>
                </div>
                <div class="param-control">
                    <label>Steer Threshold</label>
                    <input type="range" id="steer_threshold" min="0" max="0.5" value="0.15" step="0.01"
                           oninput="updateParam('decision', 'steer_threshold', this.value)">
                    <span class="param-value" id="steer_threshold_val">0.15</span>
                </div>
            </div>

            <div class="param-section">
                <h3>üöó Vehicle Control</h3>
                <div class="param-control">
                    <label>Throttle</label>
                    <input type="range" id="throttle" min="0" max="0.5" value="{throttle_base}" step="0.01"
                           oninput="updateParam('vehicle', 'throttle', this.value)">
                    <span class="param-value" id="throttle_val">{throttle_base:.2f}</span>
                </div>
            </div>
        </div>

        <div class="params-container">
            <div class="param-section">
                <h3>üìê ROI (Region of Interest) Parameters</h3>
                <div class="param-control">
                    <label>ROI Bottom Left X</label>
                    <input type="range" id="roi_bottom_left_x" min="0" max="0.3" value="{roi_bottom_left_x}" step="0.01"
                           oninput="updateParam('detection', 'roi_bottom_left_x', this.value)">
                    <span class="param-value" id="roi_bottom_left_x_val">{roi_bottom_left_x:.2f}</span>
                </div>
                <div class="param-control">
                    <label>ROI Top Left X</label>
                    <input type="range" id="roi_top_left_x" min="0.2" max="0.5" value="{roi_top_left_x}" step="0.01"
                           oninput="updateParam('detection', 'roi_top_left_x', this.value)">
                    <span class="param-value" id="roi_top_left_x_val">{roi_top_left_x:.2f}</span>
                </div>
                <div class="param-control">
                    <label>ROI Top Right X</label>
                    <input type="range" id="roi_top_right_x" min="0.5" max="0.8" value="{roi_top_right_x}" step="0.01"
                           oninput="updateParam('detection', 'roi_top_right_x', this.value)">
                    <span class="param-value" id="roi_top_right_x_val">{roi_top_right_x:.2f}</span>
                </div>
            </div>

            <div class="param-section">
                <h3>üìê ROI Parameters (continued)</h3>
                <div class="param-control">
                    <label>ROI Bottom Right X</label>
                    <input type="range" id="roi_bottom_right_x" min="0.7" max="1.0" value="{roi_bottom_right_x}" step="0.01"
                           oninput="updateParam('detection', 'roi_bottom_right_x', this.value)">
                    <span class="param-value" id="roi_bottom_right_x_val">{roi_bottom_right_x:.2f}</span>
                </div>
                <div class="param-control">
                    <label>ROI Top Y</label>
                    <input type="range" id="roi_top_y" min="0.3" max="0.7" value="{roi_top_y}" step="0.01"
                           oninput="updateParam('detection', 'roi_top_y', this.value)">
                    <span class="param-value" id="roi_top_y_val">{roi_top_y:.2f}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // WebSocket connection
        let ws = null;
        let isPaused = false;
        let hasStateData = false;
        let reconnectTimer = null;
        let frameCount = 0;
        let lastFrameTime = Date.now();
        let fpsInterval = null;

        // Get WebSocket URL (HTTP port + 1)
        const wsPort = parseInt(window.location.port || 8080) + 1;
        const wsUrl = `ws://${{window.location.hostname}}:${{wsPort}}`;

        function connectWebSocket() {{
            console.log('Connecting to WebSocket:', wsUrl);
            updateConnectionStatus('Connecting...', '#FF9800');

            ws = new WebSocket(wsUrl);

            ws.onopen = function() {{
                console.log('WebSocket connected');
                updateConnectionStatus('Connected', '#4CAF50');

                // Clear reconnect timer
                if (reconnectTimer) {{
                    clearTimeout(reconnectTimer);
                    reconnectTimer = null;
                }}

                // Start FPS counter
                startFpsCounter();
            }};

            ws.onmessage = function(event) {{
                // Check if binary (frame) or text (status)
                if (event.data instanceof Blob) {{
                    // Binary frame data
                    const img = document.getElementById('videoStream');
                    const url = URL.createObjectURL(event.data);

                    // Clean up old URL
                    if (img.src && img.src.startsWith('blob:')) {{
                        URL.revokeObjectURL(img.src);
                    }}

                    img.src = url;

                    // Update FPS counter
                    frameCount++;

                    // Latency calculation (approximate, no timestamp in binary)
                    const now = Date.now();
                    if (window.lastFrameReceived) {{
                        const latency = now - window.lastFrameReceived;
                        document.getElementById('latencyDisplay').textContent = latency.toFixed(0);
                    }}
                    window.lastFrameReceived = now;

                }} else {{
                    // Text message (status)
                    try {{
                        const msg = JSON.parse(event.data);

                        if (msg.type === 'status') {{
                            // Update state data indicator
                            if (msg.steering !== undefined || msg.speed_kmh !== undefined) {{
                                // We have actual vehicle state data
                                if (!hasStateData) {{
                                    hasStateData = true;
                                    const stateElem = document.getElementById('stateStatus');
                                    stateElem.textContent = 'Receiving';
                                    stateElem.style.color = '#4CAF50';
                                }}

                                // Update vehicle telemetry displays
                                if (msg.speed_kmh !== undefined) {{
                                    document.getElementById('speedDisplay').textContent = msg.speed_kmh.toFixed(1);
                                }}
                                if (msg.throttle !== undefined) {{
                                    document.getElementById('throttleDisplay').textContent = msg.throttle.toFixed(2);
                                }}
                                if (msg.brake !== undefined) {{
                                    const brakeElem = document.getElementById('brakeDisplay');
                                    brakeElem.textContent = msg.brake.toFixed(2);
                                    // Highlight brake when active
                                    brakeElem.style.color = msg.brake > 0.1 ? '#f44336' : '#888';
                                }}
                            }}

                            // Always update button state from paused field
                            // paused can be true, false, or undefined/null
                            if (msg.paused !== undefined && msg.paused !== null) {{
                                updateButtonState(msg.paused);
                            }}

                            // Debug: log state info
                            if (msg.steering !== undefined) {{
                                console.log('Vehicle state: steering=' + msg.steering.toFixed(3) + ', paused=' + msg.paused);
                            }}
                        }}
                    }} catch (e) {{
                        console.error('Error processing message:', e);
                    }}
                }}
            }};

            ws.onerror = function(error) {{
                console.error('WebSocket error:', error);
                updateConnectionStatus('Error', '#f44336');
            }};

            ws.onclose = function() {{
                console.log('WebSocket disconnected');
                updateConnectionStatus('Disconnected', '#f44336');

                // Stop FPS counter
                stopFpsCounter();

                // Attempt to reconnect after 2 seconds
                reconnectTimer = setTimeout(connectWebSocket, 2000);
            }};
        }}

        function updateConnectionStatus(status, color) {{
            const statusElem = document.getElementById('wsStatus');
            statusElem.textContent = status;
            statusElem.style.color = color;
        }}

        function startFpsCounter() {{
            frameCount = 0;
            lastFrameTime = Date.now();

            fpsInterval = setInterval(() => {{
                const now = Date.now();
                const elapsed = (now - lastFrameTime) / 1000;
                const fps = frameCount / elapsed;

                document.getElementById('fpsDisplay').textContent = fps.toFixed(1);

                // Reset counter
                frameCount = 0;
                lastFrameTime = now;
            }}, 1000);
        }}

        function stopFpsCounter() {{
            if (fpsInterval) {{
                clearInterval(fpsInterval);
                fpsInterval = null;
            }}
            document.getElementById('fpsDisplay').textContent = '--';
            document.getElementById('latencyDisplay').textContent = '--';
        }}

        function sendWebSocketMessage(message) {{
            if (ws && ws.readyState === WebSocket.OPEN) {{
                ws.send(JSON.stringify(message));
            }} else {{
                console.error('WebSocket not connected');
                showNotification('WebSocket not connected', true);
            }}
        }}

        function updateParam(category, parameter, value) {{
            // Update display
            const displayElem = document.getElementById(parameter + '_val');
            if (displayElem) {{
                // Format value based on parameter type
                if (parameter.includes('throttle') || parameter.includes('kp') ||
                    parameter.includes('ki') || parameter.includes('kd') ||
                    parameter.includes('steer') || parameter.includes('smoothing') ||
                    parameter.includes('roi')) {{
                    displayElem.textContent = parseFloat(value).toFixed(2);
                }} else {{
                    displayElem.textContent = Math.round(value);
                }}
            }}

            // Send via WebSocket
            sendWebSocketMessage({{
                type: 'parameter',
                category: category,
                parameter: parameter,
                value: parseFloat(value)
            }});
        }}

        function updateButtonState(paused) {{
            isPaused = paused;
            const btn = document.getElementById('pauseBtn');
            if (isPaused) {{
                btn.textContent = '‚ñ∂Ô∏è Resume';
                btn.classList.add('primary');
                btn.classList.remove('warning');
            }} else {{
                btn.textContent = 'üõë Stop';
                btn.classList.remove('primary');
                btn.classList.add('warning');
            }}
        }}

        function sendAction(action) {{
            sendWebSocketMessage({{
                type: 'action',
                action: action
            }});
            showNotification('Action sent: ' + action);
        }}

        function togglePause() {{
            sendAction(isPaused ? 'resume' : 'stop');
        }}

        function resetSystem() {{
            // Reset vehicle: set steering to 0 and pause
            sendAction('reset');

            // Reset LKAS decision module: clear PID error accumulation
            sendWebSocketMessage({{
                type: 'parameter',
                category: 'decision',
                parameter: 'reset',
                value: 1.0
            }});

            // Reset LKAS detection module: clear lane smoothing history
            sendWebSocketMessage({{
                type: 'parameter',
                category: 'detection',
                parameter: 'reset',
                value: 1.0
            }});

            showNotification('System reset: Vehicle paused, steering zeroed, all state cleared');
        }}

        // Toggle states (default: raw image, lanes, and HUD ON; canny and hough OFF)
        let rawImageEnabled = true;
        let lanesEnabled = true;
        let cannyEnabled = false;
        let houghEnabled = false;
        let hudEnabled = true;

        function toggleRawImage() {{
            rawImageEnabled = !rawImageEnabled;
            const btn = document.getElementById('rawImageToggle');

            if (rawImageEnabled) {{
                btn.textContent = 'üì∑ Raw Image: ON';
                btn.classList.remove('off');
            }} else {{
                btn.textContent = 'üì∑ Raw Image: OFF';
                btn.classList.add('off');
            }}

            // Send toggle state to viewer
            sendWebSocketMessage({{
                type: 'toggle',
                setting: 'raw_image',
                enabled: rawImageEnabled
            }});

            showNotification('Raw Image: ' + (rawImageEnabled ? 'ON' : 'OFF'));
        }}

        function toggleLanes() {{
            lanesEnabled = !lanesEnabled;
            const btn = document.getElementById('lanesToggle');

            if (lanesEnabled) {{
                btn.textContent = 'üõ£Ô∏è Lanes: ON';
                btn.classList.remove('off');
            }} else {{
                btn.textContent = 'üõ£Ô∏è Lanes: OFF';
                btn.classList.add('off');
            }}

            // Send toggle state to viewer
            sendWebSocketMessage({{
                type: 'toggle',
                setting: 'lanes',
                enabled: lanesEnabled
            }});

            showNotification('Lanes: ' + (lanesEnabled ? 'ON' : 'OFF'));
        }}

        function toggleCanny() {{
            cannyEnabled = !cannyEnabled;
            const btn = document.getElementById('cannyToggle');

            if (cannyEnabled) {{
                btn.textContent = '‚ö™ Canny: ON';
                btn.classList.remove('off');
            }} else {{
                btn.textContent = '‚ö™ Canny: OFF';
                btn.classList.add('off');
            }}

            // Send toggle state to viewer
            sendWebSocketMessage({{
                type: 'toggle',
                setting: 'canny',
                enabled: cannyEnabled
            }});

            showNotification('Canny: ' + (cannyEnabled ? 'ON' : 'OFF'));
        }}

        function toggleHough() {{
            houghEnabled = !houghEnabled;
            const btn = document.getElementById('houghToggle');

            if (houghEnabled) {{
                btn.textContent = 'üî¥ Hough: ON';
                btn.classList.remove('off');
            }} else {{
                btn.textContent = 'üî¥ Hough: OFF';
                btn.classList.add('off');
            }}

            // Send toggle state to viewer
            sendWebSocketMessage({{
                type: 'toggle',
                setting: 'hough',
                enabled: houghEnabled
            }});

            showNotification('Hough: ' + (houghEnabled ? 'ON' : 'OFF'));
        }}

        function toggleHUD() {{
            hudEnabled = !hudEnabled;
            const btn = document.getElementById('hudToggle');

            if (hudEnabled) {{
                btn.textContent = 'üìä HUD: ON';
                btn.classList.remove('off');
            }} else {{
                btn.textContent = 'üìä HUD: OFF';
                btn.classList.add('off');
            }}

            // Send toggle state to viewer
            sendWebSocketMessage({{
                type: 'toggle',
                setting: 'hud',
                enabled: hudEnabled
            }});

            showNotification('HUD: ' + (hudEnabled ? 'ON' : 'OFF'));
        }}

        function showNotification(message, isError = false) {{
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = 'notification show' + (isError ? ' error' : '');

            setTimeout(() => {{
                notif.classList.remove('show');
            }}, 3000);
        }}

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {{
            if (event.key === 's' || event.key === 'S') {{
                event.preventDefault();
                sendAction('respawn');
            }} else if (event.key === ' ') {{
                event.preventDefault();
                togglePause();
            }} else if (event.key === 'f' || event.key === 'F') {{
                event.preventDefault();
                resetSystem();
            }}
        }});

        // Connect to WebSocket on page load
        window.addEventListener('load', function() {{
            connectWebSocket();
        }});

        // Clean up on page unload
        window.addEventListener('beforeunload', function() {{
            if (ws) {{
                ws.close();
            }}
        }});
    </script>
</body>
</html>
